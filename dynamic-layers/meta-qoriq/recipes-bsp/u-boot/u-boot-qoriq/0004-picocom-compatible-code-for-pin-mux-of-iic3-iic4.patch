From 29b6a1a0261125179dfd90b12cc930571bbeac97 Mon Sep 17 00:00:00 2001
From: Gavin Gao <attinagaoxu@gmail.com>
Date: Mon, 13 Oct 2025 14:35:34 +0800
Subject: [PATCH 2/2] picocom: compatible code for pin mux of iic3/iic4


diff --git a/board/freescale/ls1046apscb/ls1046apscb.c b/board/freescale/ls1046apscb/ls1046apscb.c
index 8a110109ccd..f0f08132c3c 100644
--- a/board/freescale/ls1046apscb/ls1046apscb.c
+++ b/board/freescale/ls1046apscb/ls1046apscb.c
@@ -118,26 +118,34 @@ int power_init_board(void)
 
 void config_board_mux(void)
 {
-#ifdef CONFIG_HAS_FSL_XHCI_USB
+	const char *model;
+	ofnode root_node;
 	struct ccsr_scfg *scfg = (struct ccsr_scfg *)CFG_SYS_FSL_SCFG_ADDR;
-	u32 usb_pwrfault;
-#ifdef CONFIG_HAS_FSL_IIC3
-	/* IIC3 is used, configure mux to use IIC3_SCL/IIC3/SDA */
-	puts("IIC3 is used, configure mux to use IIC3_SCL/IIC3/SDA\n");
-	out_be32(&scfg->rcwpmuxcr0, 0x0000);
-#else
-	/* USB3 is not used, configure mux to IIC4_SCL/IIC4_SDA */
-	out_be32(&scfg->rcwpmuxcr0, 0x3300);
-#endif
-	out_be32(&scfg->usbdrvvbus_selcr, SCFG_USBDRVVBUS_SELCR_USB1);
-	usb_pwrfault = (SCFG_USBPWRFAULT_DEDICATED <<
-			SCFG_USBPWRFAULT_USB3_SHIFT) |
-			(SCFG_USBPWRFAULT_DEDICATED <<
-			SCFG_USBPWRFAULT_USB2_SHIFT) |
-			(SCFG_USBPWRFAULT_SHARED <<
-			SCFG_USBPWRFAULT_USB1_SHIFT);
-	out_be32(&scfg->usbpwrfault_selcr, usb_pwrfault);
-#endif
+
+	/* 1. Get the root node of the device tree */
+	root_node = ofnode_path("/");
+	if (!ofnode_valid(root_node)) {
+		printf("config_board_mux: Failed to find root node\n");
+		return;
+	}
+
+	/* 2. Read the "model" property from the root node */
+	model = ofnode_read_string(root_node, "model");
+	if (!model) {
+		printf("config_board_mux: Failed to read 'model' property\n");
+		return;
+	}
+
+	printf("Board model: %s\n", model);
+
+	/* 3. Configure based on the board model */
+	if (strstr(model, "LS1046A PSCB Board")) {
+		puts("Configure mux to use IIC3/IIC4\n");
+		out_be32(&scfg->rcwpmuxcr0, 0x0000);
+	} else {
+		puts("Configure mux to use IIC3/IIC4 as GPIO\n");
+		out_be32(&scfg->rcwpmuxcr0, 0x1111);
+	}
 }
 
 #ifdef CONFIG_MISC_INIT_R
-- 
2.34.1

